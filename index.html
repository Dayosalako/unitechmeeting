<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>UNGLOBAL Weekly Meeting | Secure Portal</title>
    
    <script src='https://8x8.vc/vpaas-magic-cookie-395f8038d65045c8b17c1bb294011a0c/external_api.js'></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json?v=4">

    <style>
        :root {
            --navy: #001f3f;
            --accent: #0078d4;
            --light-gray: #f4f7f9;
            --text-dark: #333;
            --success: #28a745;
            --warning: #d9534f;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray); color: var(--text-dark);
            overflow: hidden;
        }

        body {
            background: linear-gradient(135deg, #001f3f 0%, #003366 100%);
            display: flex; justify-content: center; align-items: center;
        }

        #setup-container, #post-meeting-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            text-align: center; width: 90%; max-width: 400px;
            z-index: 10;
        }

        .logo { max-width: 150px; margin-bottom: 20px; }
        h1 { color: var(--navy); font-size: 22px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        #time-status {
            font-size: 13px; font-weight: 600; padding: 12px;
            border-radius: 8px; margin-bottom: 20px;
            background: #fff5f5; color: var(--warning);
            border: 1px solid #feb2b2;
        }

        #attendance-counter {
            display: none; font-size: 12px; font-weight: 700; padding: 10px;
            border-radius: 8px; margin-bottom: 15px;
            background: #ebf8ff; color: #2b6cb0;
            border: 1px solid #bee3f8;
        }

        input {
            width: 100%; padding: 12px 15px; margin-bottom: 15px;
            border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none;
        }

        button {
            width: 100%; padding: 14px; background-color: var(--navy); color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: 0.3s;
        }

        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .admin-mode { background-color: var(--accent) !important; }
        .super-admin-mode { background: linear-gradient(to right, #b8860b, #ffd700) !important; color: #000 !important; font-weight: bold; }

        #session-header {
            display: none; background: white; width: 100%;
            padding: calc(12px + env(safe-area-inset-top)) 0 12px 0;
            text-align: center; border-bottom: 2px solid var(--accent);
            position: fixed; top: 0; z-index: 999;
        }

        #session-header h3 { margin: 0; color: var(--navy); font-size: 13px; text-transform: uppercase; }

        #meeting-frame { display: none; width: 100vw; background: black; }

        .footer-credit { position: absolute; bottom: 20px; color: rgba(255,255,255,0.4); font-size: 11px; }

        #install-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 31, 63, 0.98); z-index: 10000;
            flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center;
        }
        
        .close-x {
            position: absolute; top: 20px; right: 30px; font-size: 35px;
            cursor: pointer; color: white; font-weight: bold; opacity: 0.8;
        }

        #ios-instructions {
            display: none; background: white; color: black; padding: 20px; 
            border-radius: 15px; width: 80%; max-width: 300px; margin-top: 20px;
        }

        .password-wrapper {
            position: relative;
            width: 100%;
        }

        .password-wrapper input {
            padding-right: 45px;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 12px;
            cursor: pointer;
            font-size: 18px;
            color: #666;
            user-select: none;
            z-index: 100;
        }
    </style>
</head>
<body>

<div id="install-overlay">
    <span class="close-x" onclick="document.getElementById('install-overlay').style.display='none'">&times;</span>
    <img src="logo.png" style="max-width: 120px; margin-bottom: 20px;">
    <h2>UNGLOBAL Weekly Meeting</h2>
    <p>Install the App to enable background audio & microphone.</p>
    <button id="install-btn-main">Install App Now</button>
    <div id="ios-instructions">
        <h4 style="margin:0">iPhone/iPad Users:</h4>
        <ol style="text-align:left; font-size: 14px;">
            <li>Tap the <strong>Share</strong> icon (bottom center).</li>
            <li>Scroll down and tap <strong>Add to Home Screen</strong>.</li>
            <li>Open UNGLOBAL from your home screen.</li>
        </ol>
    </div>
</div>

<div id="session-header">
    <h3>UNGLOBAL Weekly Meeting: Official Portal</h3>
</div>

<div id="setup-container">
    <img src="logo.png" alt="Unitech Logo" class="logo" onerror="this.style.display='none'">
    <h1>UNGLOBAL WEEKLY MEETING</h1>
    
    <div id="time-status">Syncing with Nigeria Time...</div>
    <div id="attendance-counter">üë• Live Attendance: Fetching...</div>

    <div id="admin-note" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; text-align: left; border: 1px solid #ffeeba;">
        üëë <strong>Super Admin Checklist:</strong><br>
        ‚Ä¢ Ensure <strong>Otter.ai</strong> is synced.<br>
        ‚Ä¢ <span onclick="resetUserDevice()" style="text-decoration: underline; cursor: pointer; color: #0078d4;">Reset Staff Device ID</span><br>
        ‚Ä¢ <span onclick="clearAttendanceData()" style="text-decoration: underline; cursor: pointer; color: #d9534f;">Clear Attendance List</span>
    </div>

    <div style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee;">
        <div id="tab-login" onclick="toggleAuthMode('login')" style="flex:1; padding:10px; cursor:pointer; font-weight:700; color:var(--navy); border-bottom: 3px solid var(--navy);">LOGIN</div>
        <div id="tab-signup" onclick="toggleAuthMode('signup')" style="flex:1; padding:10px; cursor:pointer; font-weight:700; color:#999;">SIGN UP</div>
    </div>

    <input type="text" id="username" placeholder="Username" oninput="updateClock()">
    <input type="text" id="display_name" placeholder="Your Full Name" style="display:none;">

    <div class="password-wrapper">
        <input type="password" id="staff-password" placeholder="Password">
        <span id="eye-icon" class="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</span>
    </div>
    
    <button id="login-btn" onclick="handleAuth()" disabled>Locked</button>

    <div style="background: #f0fff4; color: #22543d; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 11px; text-align: left; border: 1px solid #c6f6d5;">
        ü§ñ <strong>System:</strong> New staff must "Sign Up" first.
    </div>
</div>

<div id="meeting-frame"></div>

<div id="post-meeting-container" style="display: none;">
    <img src="logo.png" alt="Logo" class="logo" style="max-width: 100px; cursor: help;" onclick="revealAdminButton()">
    <h2>Meeting Concluded</h2>
    <p>Attendance logged. Credentials saved.</p>
    <button onclick="location.reload()" style="background: var(--success); margin-bottom: 10px;">üîÑ Quick Reconnect</button>
    <button id="admin-download-btn" onclick="window.open('https://otter.ai/my-notes')" style="background: var(--success); display:none;">üìÇ Open Otter.ai</button>
    <br><br>
    <button onclick="logout()" style="background: #666; width: auto; padding: 10px 20px;">Logout & Clear Storage</button>
</div>

<div class="footer-credit">Powered by Zion Netcom Solutions Limited</div>

<script>
    const authURL = "https://script.google.com/macros/s/AKfycbxWstMgkuxiWnw8Ky-YVn45QXy0nCMrbc03SGIH6QWdMZn_YsncroeMxiyDcKWq9pac/exec"; 
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyMHBYtIVUpBkRZZLS6Le0mq7p0_PIOKIdn19awHUSVaSpgsg8uV9DckVtU2_ZeMaEADQ/exec';
    const ROOM_NAME = "vpaas-magic-cookie-395f8038d65045c8b17c1bb294011a0c/Unitech-Global-Weekly-Meeting";
    
    const SUPER_ADMIN = "dayosalako";
    const ADMIN_LIST = ["temitopeadeyemi", "faizeljappie", "kabiroyekunle", "topeokunlola"];
    const ALL_BYPASS = [SUPER_ADMIN, ...ADMIN_LIST];

    let api = null;
    let inMeeting = false;
    let wakeLock = null;
    let deferredPrompt;
    let authMode = 'login';

    // Added Toggle Function (Fixed naming to match HTML)
    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('staff-password');
        const eyeIcon = document.getElementById('eye-icon');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.innerText = 'üîí';
        } else {
            passwordInput.type = 'password';
            eyeIcon.innerText = 'üëÅÔ∏è';
        }
    }

    function getDeviceId() {
        let id = localStorage.getItem('unitech_device_id');
        if (!id) {
            id = 'dev-' + Math.random().toString(36).substr(2, 9) + Date.now();
            localStorage.setItem('unitech_device_id', id);
        }
        return id;
    }

    window.onload = () => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js?v=4');
        }

        const isApp = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

        if (isApp) {
            document.getElementById('install-overlay').style.display = 'none';
            const sessionActive = localStorage.getItem('unitech_session_active');
            const savedName = localStorage.getItem('unitech_display_name');
            if (sessionActive === "true" && savedName) {
                startMeeting(savedName);
            }
        } else {
            if (localStorage.getItem('app_already_installed') === 'true') {
                document.body.innerHTML = `
                    <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#001f3f; color:white; text-align:center; padding:20px;">
                        <img src="logo.png" width="100" style="margin-bottom:20px;">
                        <h2>Portal is Ready</h2>
                        <p>Please open the <b>UNGLOBAL</b> app from your home screen.</p>
                        <button onclick="location.reload()" style="background:#28a745; color:white; border:none; padding:10px 20px; border-radius:5px;">Refresh</button>
                    </div>
                `;
                return;
            } else {
                document.getElementById('install-overlay').style.display = 'flex';
                if (/iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase())) {
                    document.getElementById('ios-instructions').style.display = 'block';
                    document.getElementById('install-btn-main').style.display = 'none';
                }
            }
        }

        updateClock();
        setInterval(updateClock, 1000);
    };

    function updateClock() {
        if (inMeeting) return;
        const now = new Date();
        const nigeria = new Date(now.toLocaleString("en-US", {timeZone: "Africa/Lagos"}));
        const day = nigeria.getDay(); 
        const hrs = nigeria.getHours();
        const mins = nigeria.getMinutes();
        
        const statusBox = document.getElementById('time-status');
        const loginBtn = document.getElementById('login-btn');
        const adminNote = document.getElementById('admin-note');
        const userIn = document.getElementById('username').value.trim().toLowerCase();

        const isFriday = (day === 5);
        const isTime = (hrs > 8 || (hrs === 8 && mins >= 55));

        if (userIn === SUPER_ADMIN) {
            statusBox.style.background = "#fff9db"; statusBox.style.color = "#b8860b";
            statusBox.innerHTML = "üëë SUPER ADMIN ACCESS: ONLINE";
            loginBtn.disabled = false; loginBtn.innerText = authMode === 'signup' ? "Create Admin" : "Enter as Super Admin";
            loginBtn.className = "super-admin-mode";
            adminNote.style.display = "block";
            document.getElementById('attendance-counter').style.display = "block";
            fetchAttendance();
        } 
        else if (ADMIN_LIST.includes(userIn)) {
            statusBox.style.background = "#eef6ff"; statusBox.style.color = "#0078d4";
            statusBox.innerHTML = "üíé ADMIN ACCESS ACTIVE";
            loginBtn.disabled = false; loginBtn.innerText = authMode === 'signup' ? "Create Admin" : "Enter Admin Meeting";
            loginBtn.className = "admin-mode";
            adminNote.style.display = "none"; 
            document.getElementById('attendance-counter').style.display = "block";
            fetchAttendance();
        } 
        else {
            loginBtn.className = "";
            adminNote.style.display = "none";
            if (isFriday && isTime) {
                statusBox.style.background = "#f0fff4"; statusBox.style.color = "#28a745";
                statusBox.innerHTML = "‚úÖ MEETING IS OPEN";
                loginBtn.disabled = false; loginBtn.innerText = authMode === 'signup' ? "Create My Account" : "Join Meeting";
            } else {
                statusBox.style.background = "#fff5f5"; statusBox.style.color = "#d9534f";
                statusBox.innerHTML = "üîí LOCKED UNTIL FRIDAY 8:55 AM";
                loginBtn.disabled = true; loginBtn.innerText = "Meeting Locked";
            }
        }
    }

    function toggleAuthMode(mode) {
        authMode = mode;
        const nameField = document.getElementById('display_name');
        const tabL = document.getElementById('tab-login');
        const tabS = document.getElementById('tab-signup');

        if (mode === 'signup') {
            nameField.style.display = 'block';
            tabS.style.color = "var(--navy)"; tabS.style.borderBottom = "3px solid var(--navy)";
            tabL.style.color = "#999"; tabL.style.borderBottom = "none";
        } else {
            nameField.style.display = 'none';
            tabL.style.color = "var(--navy)"; tabL.style.borderBottom = "3px solid var(--navy)";
            tabS.style.color = "#999"; tabS.style.borderBottom = "none";
        }
        updateClock();
    }

    async function handleAuth() {
        const userIn = document.getElementById('username').value.trim().toLowerCase();
        const passIn = document.getElementById('staff-password').value;
        const nameIn = document.getElementById('display_name').value.trim();
        const deviceId = getDeviceId();
        const btn = document.getElementById('login-btn');

        if (authMode === 'signup' && (!userIn || !passIn || !nameIn)) {
            alert("Please fill in all fields."); return;
        }

        btn.innerText = "Processing..."; btn.disabled = true;

        try {
            const response = await fetch(authURL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: authMode === 'signup' ? "signup" : "login_check", 
                    username: userIn, password: passIn, displayName: nameIn, deviceId: deviceId 
                }) 
            });
            const result = await response.json();
            
            if (result.status === "success") {
                if (authMode === 'signup') {
                    alert("Account Created! You can now Login.");
                    toggleAuthMode('login');
                } else {
                    localStorage.setItem('unitech_user_id', userIn);
                    localStorage.setItem('unitech_display_name', result.displayName);
                    localStorage.setItem('unitech_session_active', "true");
                    startMeeting(result.displayName);
                }
            } else {
                alert(result.message); btn.disabled = false; updateClock();
            }
        } catch (e) {
            alert("Connection error."); btn.disabled = false;
        }
    }

    async function startMeeting(displayName) {
        if (api) api.dispose(); 
        inMeeting = true;

        document.getElementById('setup-container').style.display = 'none';
        const header = document.getElementById('session-header');
        const frame = document.getElementById('meeting-frame');
        header.style.display = 'block'; frame.style.display = 'block';

        const headerHeight = header.offsetHeight;
        frame.style.marginTop = headerHeight + 'px';
        frame.style.height = `calc(100vh - ${headerHeight}px)`;

        if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }

        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: displayName, action: "Joined" }) });

        api = new JitsiMeetExternalAPI("8x8.vc", {
            roomName: ROOM_NAME,
            width: "100%", height: "100%",
            parentNode: document.querySelector('#meeting-frame'),
            userInfo: { displayName: displayName },
            configOverwrite: { startWithAudioMuted: true, prejoinPageEnabled: false, lobby: { enabled: true } }
        });

        api.addEventListener('videoConferenceLeft', () => {
            inMeeting = false;
            localStorage.removeItem('unitech_session_active');
            if (wakeLock) wakeLock.release();
            window.location.reload();
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

    document.getElementById('install-btn-main').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                localStorage.setItem('app_already_installed', 'true');
                document.getElementById('install-overlay').style.display = 'none';
            }
        }
    });

    window.addEventListener('appinstalled', () => {
        localStorage.setItem('app_already_installed', 'true');
        alert("‚úÖ Installed! Open the 'UNGLOBAL' App.");
    });

    async function fetchAttendance() {
        try {
            const res = await fetch(scriptURL + "?action=getCount");
            const data = await res.json();
            document.getElementById('attendance-counter').innerText = `üë• Live Attendance: ${data.count} Staff Online`;
        } catch (e) {}
    }

    async function resetUserDevice() {
        const target = prompt("Enter Username to Reset:");
        if (target) {
            await fetch(authURL, { method: 'POST', body: JSON.stringify({ action: "reset_device", username: target.toLowerCase() }) });
            alert("Reset request sent.");
        }
    }

    async function clearAttendanceData() {
        if (confirm("Clear attendance?")) {
            await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "clear_attendance" }) });
            alert("Attendance cleared.");
        }
    }

    function revealAdminButton() {
        if (prompt("Admin Password:") === "Salako2020") {
            document.getElementById('admin-download-btn').style.display = "block";
        }
    }

    function logout() { localStorage.clear(); window.location.reload(); }
</script>
</body>
</html>
