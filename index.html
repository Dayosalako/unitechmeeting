<!DOCTYPE html>                                         
                                      
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Unitech Global Meeting | Secure Portal</title>
    
    <script src='https://8x8.vc/vpaas-magic-cookie-395f8038d65045c8b17c1bb294011a0c/external_api.js'></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --navy: #001f3f;
            --accent: #0078d4;
            --gold: #FFD700;
            --light-gray: #f4f7f9;
            --text-dark: #333;
            --success: #28a745;
            --warning: #d9534f;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray); color: var(--text-dark);
            overflow: hidden;
        }

        body {
            background: linear-gradient(135deg, #001f3f 0%, #003366 100%);
            display: flex; justify-content: center; align-items: center;
        }

        /* SECTION: UI Containers - RESTORED */
        #setup-container, #post-meeting-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            text-align: center; width: 90%; max-width: 400px;
            z-index: 10;
        }

        .logo { max-width: 150px; margin-bottom: 20px; }
        h1 { color: var(--navy); font-size: 24px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        /* SECTION: Time Lock Styling - RESTORED */
        #time-status {
            font-size: 13px; font-weight: 600; padding: 12px;
            border-radius: 8px; margin-bottom: 20px;
            background: #fff5f5; color: var(--warning);
            border: 1px solid #feb2b2;
        }

        #attendance-counter {
            display: none; font-size: 12px; font-weight: 700; padding: 10px;
            border-radius: 8px; margin-bottom: 15px;
            background: #ebf8ff; color: #2b6cb0;
            border: 1px solid #bee3f8;
        }

        input {
            width: 100%; padding: 12px 15px; margin-bottom: 15px;
            border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none;
        }

        button {
            width: 100%; padding: 14px; background-color: var(--navy); color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: 0.3s;
        }

        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Bypass Highlight Logic */
        .admin-mode { background-color: var(--accent) !important; box-shadow: 0 0 15px rgba(0,120,212,0.5); }
        .super-admin-mode { background: linear-gradient(to right, #b8860b, #ffd700) !important; color: #000 !important; border: 1px solid #b8860b; }

        /* SECTION: Header with Notch Fix - RESTORED */
        #session-header {
            display: none; background: white; width: 100%;
            padding: calc(12px + env(safe-area-inset-top)) 0 12px 0;
            text-align: center; border-bottom: 2px solid var(--accent);
            position: fixed; top: 0; z-index: 999;
        }

        #session-header h3 { margin: 0; color: var(--navy); font-size: 13px; text-transform: uppercase; }
        #meeting-frame { display: none; width: 100vw; background: black; }
        .footer-credit { position: absolute; bottom: 20px; color: rgba(255,255,255,0.4); font-size: 11px; }
        #admin-download-btn { display: none; margin-top: 20px; background-color: var(--success); }

        /* PWA Install Styling - RESTORED */
        #install-area {
            display: none; background: #eef6ff; border: 1px solid #0078d4;
            padding: 10px; border-radius: 8px; margin-bottom: 15px;
        }
        #install-btn { background: var(--accent); font-size: 13px; padding: 8px; margin-top: 5px; width: auto; }
        #ios-install-note {
            display: none; background: #fff; border: 2px dashed var(--accent);
            padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .ios-step { display: flex; align-items: center; font-size: 13px; margin-bottom: 8px; color: var(--navy); }
        .ios-icon { width: 24px; height: 24px; margin-right: 10px; }
    </style>
</head>
<body>

    <div id="session-header">
        <h3>Unitech Global Resources Ltd: Official Weekly Meeting</h3>
    </div>

    <div id="setup-container">
        <img src="logo.png" alt="Unitech Logo" class="logo" onerror="this.style.display='none'">
        <h1 id="portal-title">Staff Weekly Meeting Portal</h1>
        
        <div id="time-status">Syncing with Nigeria Time...</div>
        <div id="attendance-counter">üë• Live Attendance: Fetching...</div>

        <div id="admin-note" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; text-align: left; border: 1px solid #ffeeba;">
            ‚ö†Ô∏è <strong>Administrative Access Active:</strong><br>
            ‚Ä¢ Time Lock Bypassed (24/7 Access)<br>
            ‚Ä¢ Management Control Enabled
        </div>

        <div style="background: #f0fff4; color: #22543d; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; text-align: left; border: 1px solid #c6f6d5;">
            ü§ñ <strong>Welcome:</strong> The Management of Unitech Global Resources Welcome you to another weekly meeting.
        </div>

        <div id="install-area">
            <span style="font-size: 12px; color: var(--navy);">Install the Unitech App for a better experience:</span>
            <button id="install-btn">üì≤ Install Now</button>
        </div>

        <div id="ios-install-note">
            <strong style="color: var(--accent); font-size: 14px;">Add to Home Screen (iPhone)</strong>
            <p style="font-size: 12px; color: #666; margin: 5px 0 10px 0;">To use this as a full app:</p>
            <div class="ios-step">
                <img src="https://img.icons8.com/ios/50/0078d4/safari-share.png" class="ios-icon">
                <span>1. Tap the <strong>Share</strong> button at the bottom.</span>
            </div>
            <div class="ios-step">
                <img src="https://img.icons8.com/ios/50/0078d4/plus-math.png" class="ios-icon">
                <span>2. Scroll down and tap <strong>Add to Home Screen</strong>.</span>
            </div>
            <button onclick="document.getElementById('ios-install-note').style.display='none'" style="background:#eee; color:#333; font-size:11px; padding:5px; margin-top:5px; width:auto; border: 1px solid #ccc;">Dismiss</button>
        </div>
        
        <input type="text" id="username" placeholder="Username" oninput="checkBypass()">
        <input type="password" id="staff-password" placeholder="Password">
        
        <button id="login-btn" onclick="handleLogin()" disabled>Locked</button>
    </div>

    <div id="meeting-frame"></div>

    <div id="post-meeting-container" style="display: none;">
        <img src="logo.png" alt="Unitech Logo" class="logo" style="max-width: 100px; cursor: help;" onclick="revealAdminButton()">
        <h2>Meeting Session</h2>
        <p>Attendance has been logged successfully.</p>
        
        <button onclick="location.reload()" style="background-color: var(--success); margin-bottom: 10px;">üîÑ Quick Reconnect</button>
        
        <button id="admin-download-btn" onclick="window.open('https://otter.ai/my-notes')">üìÇ Open Otter.ai Minutes</button>
        <br><br>
        <button onclick="logout()" style="background: #666; width: auto; padding: 10px 20px;">Logout & Exit</button>
    </div>

    <div class="footer-credit">Powered by Zion Netcom Solutions Limited</div>

    <script>
        const authURL = "https://script.google.com/macros/s/AKfycbzue0dhfA5yc-aOEeVZcBYYs-l-q5fFfMTHCtlLTjLvJX0lzOQBwyknhPKgCYD_81Oy/exec"; 
        const scriptURL = authURL; 
        const ROOM_NAME = "vpaas-magic-cookie-395f8038d65045c8b17c1bb294011a0c/Unitech-Global-Weekly-Meeting";
        
        // ADMIN LIST
        const SUPER_ADMIN = "dayosalako";
        const ADMIN_LIST = ["temitopeadeyemi", "faizeljappie", "kabiroyekunle"];
        const ALL_BYPASS = [SUPER_ADMIN, ...ADMIN_LIST];

        let api = null;
        let isGlobalMeetingTime = false;
        let inMeeting = false; // ANTI-REFRESH TRACKER

        // --- NEW ANTI-REFRESH LOGIC ---
        window.onbeforeunload = function() {
            if (inMeeting) {
                return "A meeting is currently in progress. Are you sure you want to leave?";
            }
        };

        function updateClock() {
            const nigeria = new Date(new Date().toLocaleString("en-US", {timeZone: "Africa/Lagos"}));
            const day = nigeria.getDay(); 
            const hrs = nigeria.getHours();
            const mins = nigeria.getMinutes();
            
            const statusBox = document.getElementById('time-status');
            const loginBtn = document.getElementById('login-btn');
            const title = document.getElementById('portal-title');
            const counterBox = document.getElementById('attendance-counter');
            const currentInput = document.getElementById('username').value.trim().toLowerCase();

            const isFriday = (day === 5);
            const isTime = (hrs > 8 || (hrs === 8 && mins >= 55));

            if (currentInput === SUPER_ADMIN) {
                statusBox.style.background = "#fff9db"; statusBox.style.color = "#856404";
                statusBox.innerHTML = "üëë SUPER ADMIN BYPASS ACTIVE";
                title.innerText = "Command Center";
                loginBtn.disabled = false; loginBtn.innerText = "Enter Room as Super Admin";
                loginBtn.className = "super-admin-mode";
                document.getElementById('admin-note').style.display = "block";
                counterBox.style.display = "block";
                fetchAttendance();
            } 
            else if (ADMIN_LIST.includes(currentInput)) {
                statusBox.style.background = "#eef6ff"; statusBox.style.color = "#0078d4";
                statusBox.innerHTML = "üíé Admin Access Recognized (24/7)";
                title.innerText = "Admin Portal";
                loginBtn.disabled = false; loginBtn.innerText = "Admin Login";
                loginBtn.className = "admin-mode";
                document.getElementById('admin-note').style.display = "block";
                counterBox.style.display = "block";
                fetchAttendance();
            }
            else if (isFriday && isTime) {
                isGlobalMeetingTime = true;
                statusBox.style.background = "#f0fff4"; statusBox.style.color = "#28a745";
                statusBox.innerHTML = "‚úÖ Meeting is OPEN (Starts 9:00 AM)";
                title.innerText = "Staff Portal";
                loginBtn.disabled = false; loginBtn.innerText = "Login & Join Meeting";
                loginBtn.className = "";
                document.getElementById('admin-note').style.display = "none";
                counterBox.style.display = "none";
            } 
            else {
                isGlobalMeetingTime = false;
                loginBtn.disabled = true; loginBtn.innerText = "Meeting Locked";
                loginBtn.className = "";
                statusBox.style.background = "#fff5f5"; statusBox.style.color = "#d9534f";
                statusBox.innerHTML = "üîí Closed. Unlocks Friday at 8:55 AM.";
                title.innerText = "Staff Portal";
                document.getElementById('admin-note').style.display = "none";
                counterBox.style.display = "none";
            }
        }

        async function fetchAttendance() {
            try {
                const res = await fetch(scriptURL + "?action=getCount");
                const data = await res.json();
                document.getElementById('attendance-counter').innerText = `üë• Live Attendance: ${data.count} Staff Online`;
            } catch (e) {}
        }

        function checkBypass() { updateClock(); }
        setInterval(updateClock, 1000);
        setInterval(() => { 
            const val = document.getElementById('username').value.trim().toLowerCase();
            if(ALL_BYPASS.includes(val)) fetchAttendance(); 
        }, 30000);
        updateClock();

        window.onload = () => {
            const savedName = localStorage.getItem('unitech_display_name');
            const isLoggedIn = localStorage.getItem('unitech_authenticated');
            const savedUser = (localStorage.getItem('unitech_user_id') || "").toLowerCase();
            
            if (isLoggedIn === "true" && savedName) {
                if (isGlobalMeetingTime || ALL_BYPASS.includes(savedUser)) {
                    startMeeting(true, savedName);
                }
            }
        };

        async function handleLogin() {
            const userIn = document.getElementById('username').value.trim().toLowerCase();
            const passIn = document.getElementById('staff-password').value;
            const btn = document.getElementById('login-btn');
            btn.innerText = "Authenticating..."; btn.disabled = true;

            try {
                const response = await fetch(authURL, { method: 'POST', body: JSON.stringify({ username: userIn, password: passIn }) });
                const result = await response.json();
                if (result.status === "success") {
                    localStorage.setItem('unitech_user_id', userIn);
                    localStorage.setItem('unitech_display_name', result.displayName);
                    localStorage.setItem('unitech_authenticated', "true");
                    startMeeting(false, result.displayName);
                } else { alert("Invalid Credentials."); updateClock(); }
            } catch (e) { alert("Auth Connection Error."); updateClock(); }
        }

        async function startMeeting(isAuto, displayName) {
            inMeeting = true; // LOCK REFRESH
            document.getElementById('setup-container').style.display = 'none';
            const header = document.getElementById('session-header');
            const frame = document.getElementById('meeting-frame');
            header.style.display = 'block'; frame.style.display = 'block';
            frame.style.marginTop = header.offsetHeight + 'px';
            frame.style.height = `calc(100vh - ${header.offsetHeight}px)`;

            if (!isAuto) fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: displayName, action: "Joined" }) });

            api = new JitsiMeetExternalAPI("8x8.vc", {
                roomName: ROOM_NAME, width: "100%", height: "100%",
                parentNode: document.querySelector('#meeting-frame'),
                userInfo: { displayName: displayName },
                configOverwrite: { startWithAudioMuted: true, prejoinPageEnabled: false }
            });
            
            api.addEventListener('videoConferenceLeft', () => { 
                inMeeting = false; // UNLOCK REFRESH
                document.getElementById('session-header').style.display = 'none';
                document.getElementById('meeting-frame').style.display = 'none';
                document.getElementById('post-meeting-container').style.display = 'block';
                api.dispose();
            });
        }

        function revealAdminButton() {
            if (prompt("Admin Password:") === "Salako2020") document.getElementById('admin-download-btn').style.display = "block";
        }

        function logout() { inMeeting = false; localStorage.clear(); window.location.reload(); }

        window.addEventListener('load', () => {
            const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
            const isStandalone = ('standalone' in window.navigator) && (window.navigator.standalone);
            if (isIos && !isStandalone) document.getElementById('ios-install-note').style.display = 'block';
        });

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>

