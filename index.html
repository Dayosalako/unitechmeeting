<!DOCTYPE html>                                                                                                    
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>UNGLOBAL Weekly Meeting | Secure Portal</title>
    
    <script src='https://8x8.vc/vpaas-magic-cookie-395f8038d65045c8b17c1bb294011a0c/external_api.js'></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json?v=4">

    <style>
        :root {
            --navy: #001f3f;
            --accent: #0078d4;
            --light-gray: #f4f7f9;
            --text-dark: #333;
            --success: #28a745;
            --warning: #d9534f;
            --gold: linear-gradient(to right, #b8860b, #ffd700);
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray); color: var(--text-dark);
            overflow: hidden;
        }

        body {
            background: linear-gradient(135deg, #001f3f 0%, #003366 100%);
            display: flex; justify-content: center; align-items: center;
        }

        #setup-container, #post-meeting-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            text-align: center; width: 90%; max-width: 400px;
            z-index: 10;
            max-height: 90vh; overflow-y: auto;
        }

        .logo { max-width: 150px; margin-bottom: 20px; }
        h1 { color: var(--navy); font-size: 22px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        #time-status {
            font-size: 13px; font-weight: 600; padding: 12px;
            border-radius: 8px; margin-bottom: 20px;
            background: #fff5f5; color: var(--warning);
            border: 1px solid #feb2b2;
            transition: all 0.3s ease;
        }

        .super-admin-status {
            background: var(--gold) !important;
            color: #000 !important;
            border: 1px solid #b8860b !important;
            font-weight: bold !important;
        }

        #attendance-counter {
            display: none; font-size: 12px; font-weight: 700; padding: 10px;
            border-radius: 8px; margin-bottom: 15px;
            background: #ebf8ff; color: #2b6cb0;
            border: 1px solid #bee3f8;
            animation: slideDownCounter 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideDownCounter {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* UPDATED TAB SYSTEM TO PREVENT SHIFTING */
        .tab-container {
            display: flex; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #eee;
            position: relative;
        }
        .tab-item {
            flex: 1; 
            padding: 12px; 
            cursor: pointer; 
            font-weight: 700; 
            color: #999;
            transition: all 0.3s ease;
            text-align: center;
        }
        .tab-item.active {
            color: var(--navy);
        }
        .tab-indicator {
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 50%;
            height: 3px;
            background-color: var(--navy);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input, select {
            width: 100%; padding: 12px 15px; margin-bottom: 15px;
            border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none;
        }

        button {
            width: 100%; padding: 14px; background-color: var(--navy); color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        button:active { transform: scale(0.97); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .super-admin-btn {
            background: var(--gold) !important;
            color: #000 !important;
        }

        .btn-loading { color: transparent !important; pointer-events: none; }
        .btn-loading::after {
            content: ""; position: absolute; width: 22px; height: 22px;
            top: 50%; left: 50%; margin: -11px 0 0 -11px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        #session-header {
            display: none; background: white; width: 100%;
            padding: calc(12px + env(safe-area-inset-top)) 0 12px 0;
            text-align: center; border-bottom: 2px solid var(--accent);
            position: fixed; top: 0; z-index: 999;
        }
        #session-header h3 { margin: 0; color: var(--navy); font-size: 13px; text-transform: uppercase; }
        #meeting-frame { display: none; width: 100vw; background: black; }
        .footer-credit { position: absolute; bottom: 20px; color: rgba(255,255,255,0.4); font-size: 11px; }

        #install-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; flex-direction: column; justify-content: center; align-items: center; 
            color: white; text-align: center; background: rgba(0, 31, 63, 0.85) !important;
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        }
        .close-x { position: absolute; top: 20px; right: 30px; font-size: 35px; cursor: pointer; color: white; font-weight: bold; opacity: 0.8; }
        #ios-instructions {
            display: none; background: white; color: black; padding: 20px; 
            border-radius: 15px; width: 80%; max-width: 300px; margin-top: 20px;
        }

        .password-wrapper { position: relative; width: 100%; }
        .password-wrapper input { padding-right: 45px; }
        .toggle-password {
            position: absolute; right: 15px; top: 12px; cursor: pointer;
            font-size: 18px; color: #666; user-select: none; z-index: 100;
        }

        #custom-alert {
            display: none; position: fixed; top: 25px; left: 50%;
            transform: translateX(-50%); background: white; padding: 16px 28px;
            border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            z-index: 20000; font-weight: 600; font-size: 14px; color: var(--navy);
            border-left: 6px solid var(--accent);
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideDown { from { top: -100px; opacity: 0; } to { top: 25px; opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="custom-alert"></div>

<div id="recovery-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:20001; justify-content:center; align-items:center; backdrop-filter: blur(5px);">
    <div style="background:white; width:90%; max-width:380px; padding:30px; border-radius:20px; position:relative; animation: slideUp 0.3s ease-out;">
        <span onclick="closeRecoveryModal()" style="position:absolute; top:15px; right:20px; font-size:24px; cursor:pointer; color:#999;">&times;</span>
        <h2 style="color:var(--navy); margin-top:0;">Account Recovery</h2>
        <p style="font-size:13px; color:#666; margin-bottom:20px;">Please verify your identity to reset your password.</p>
        <div id="recovery-step-1">
            <input type="text" id="recover-username" placeholder="Username">
            <button onclick="showRecoveryStep2()" style="background:var(--accent);">Next</button>
        </div>
        <div id="recovery-step-2" style="display:none;">
            <p style="font-size:12px; font-weight:bold; color:var(--navy); text-align:left; margin-bottom:5px;">Security Question Answer:</p>
            <input type="text" id="recover-answer" placeholder="Your Security Answer">
            <input type="password" id="recover-new-pass" placeholder="New Password">
            <button id="recover-submit-btn" onclick="submitRecovery()" style="background:var(--success);">Reset Password</button>
        </div>
    </div>
</div>

<div id="install-overlay">
    <span class="close-x" onclick="document.getElementById('install-overlay').style.display='none'">&times;</span>
    <img src="logo.png" style="max-width: 120px; margin-bottom: 20px;">
    <h2>UNGLOBAL Weekly Meeting</h2>
    <p>Install the App to enable background audio & microphone.</p>
    <button id="install-btn-main" style="background: var(--success); width:250px;">Install App Now</button>
    <div id="ios-instructions">
        <h4 style="margin:0">iPhone/iPad Users:</h4>
        <ol style="text-align:left; font-size: 14px;">
            <li>Tap the <strong>Share</strong> icon (bottom center).</li>
            <li>Scroll down and tap <strong>Add to Home Screen</strong>.</li>
            <li>Open UNGLOBAL from your home screen.</li>
        </ol>
    </div>
</div>

<div id="session-header"><h3>UNGLOBAL Weekly Meeting: Official Portal</h3></div>

<div id="setup-container">
    <img src="logo.png" alt="Unitech Logo" class="logo" onerror="this.style.display='none'">
    <h1>UNGLOBAL WEEKLY MEETING</h1>
    
    <div id="time-status">Syncing with Nigeria Time...</div>
    <div id="attendance-counter">üë• Live Attendance: Fetching...</div>

    <div id="admin-note" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; text-align: left; border: 1px solid #ffeeba;">
        üëë <strong>Super Admin Checklist:</strong><br>
        ‚Ä¢ Ensure <strong>Otter.ai</strong> is synced.<br>
        ‚Ä¢ <span onclick="resetUserDevice()" style="text-decoration: underline; cursor: pointer; color: #0078d4;">Reset Staff Device ID</span><br>
        ‚Ä¢ <span onclick="clearAttendanceData()" style="text-decoration: underline; cursor: pointer; color: #d9534f;">Clear Attendance List</span>
    </div>

    <div class="tab-container">
        <div id="tab-login" class="tab-item active" onclick="toggleAuthMode('login')">LOGIN</div>
        <div id="tab-signup" class="tab-item" onclick="toggleAuthMode('signup')">SIGN UP</div>
        <div id="tab-indicator" class="tab-indicator"></div>
    </div>

    <input type="text" id="username" placeholder="Username" oninput="updateClock()">
    <input type="text" id="display_name" placeholder="Your Full Name" style="display:none;">

    <div class="password-wrapper">
        <input type="password" id="staff-password" placeholder="Password">
        <span id="eye-icon" class="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</span>
    </div>

    <div id="security-section" style="display:none;">
        <input type="password" id="confirm-password" placeholder="Confirm Password">
        <select id="security_question">
            <option value="" disabled selected>Select Security Question</option>
            <option value="maiden">Mother's Maiden Name?</option>
            <option value="school">Name of your primary school?</option>
            <option value="pet">Name of your first pet?</option>
            <option value="city">City where you were born?</option>
        </select>
        <input type="text" id="security_answer" placeholder="Your Security Answer">
    </div>
    
    <button id="login-btn" onclick="handleAuth()" disabled>Locked</button>

    <div id="forgot-password-area" style="margin-top: 15px;">
        <a href="javascript:void(0)" onclick="forgotPassword()" style="color: var(--accent); font-size: 12px; text-decoration: none; font-weight: 600;">Forgot Password?</a>
    </div>
</div>

<div id="meeting-frame"></div>

<div id="post-meeting-container" style="display: none;">
    <img src="logo.png" alt="Logo" class="logo" style="max-width: 100px; cursor: help;" onclick="revealAdminButton()">
    <h2>Meeting Concluded</h2>
    <p>Attendance logged.</p>
    <button onclick="location.reload()" style="background: var(--success); margin-bottom: 10px;">üîÑ Quick Reconnect</button>
    <button id="admin-download-btn" onclick="window.open('https://otter.ai/my-notes')" style="background: var(--success); display:none;">üìÇ Open Otter.ai</button>
    <br><br>
    <button onclick="logout()" style="background: #666; width: auto; padding: 10px 20px;">Logout & Clear Storage</button>
</div>

<div class="footer-credit">Powered by Zion Netcom Solutions Limited</div>

<script>
    const authURL = "https://script.google.com/macros/s/AKfycbwmeHNJugt0B5BS-oAGykYDf4p-HMWpF8GT5G4cPs4vQq-3-ERByXK9qPi1nRh_rtmd/exec"; 
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyMHBYtIVUpBkRZZLS6Le0mq7p0_PIOKIdn19awHUSVaSpgsg8uV9DckVtU2_ZeMaEADQ/exec';
    const ROOM_NAME = "vpaas-magic-cookie-395f8038d65045c8b17c1bb294011a0c/Unitech-Global-Weekly-Meeting";
    
    const SUPER_ADMIN = "dayosalako";
    const ADMIN_LIST = ["temitopeadeyemi", "faizeljappie", "kabiroyekunle", "topeokunlola"];
    const ALL_BYPASS = [SUPER_ADMIN, ...ADMIN_LIST];

    let api = null; let inMeeting = false; let wakeLock = null; let authMode = 'login';

    function showAlert(message) {
        const alertBox = document.getElementById('custom-alert');
        alertBox.innerText = message; alertBox.style.display = 'block';
        setTimeout(() => { alertBox.style.display = 'none'; }, 4000);
    }

    function forgotPassword() { document.getElementById('recovery-modal').style.display = 'flex'; }
    function closeRecoveryModal() { document.getElementById('recovery-modal').style.display = 'none'; }
    
    function showRecoveryStep2() { 
        if(!document.getElementById('recover-username').value.trim()) { showAlert("Enter username."); return; }
        document.getElementById('recovery-step-1').style.display = 'none'; 
        document.getElementById('recovery-step-2').style.display = 'block'; 
    }

    async function submitRecovery() {
        const user = document.getElementById('recover-username').value.trim();
        const answer = document.getElementById('recover-answer').value.trim();
        const newPass = document.getElementById('recover-new-pass').value;
        const btn = document.getElementById('recover-submit-btn');
        if (!answer || !newPass) { showAlert("Fill in all fields."); return; }
        btn.classList.add('btn-loading'); btn.disabled = true;
        try {
            const response = await fetch(authURL, { method: 'POST', body: JSON.stringify({ action: "reset_password", username: user.toLowerCase(), securityAnswer: answer.toLowerCase(), newPassword: newPass })});
            const result = await response.json();
            if (result.status === "success") { showAlert("‚úÖ Password Updated!"); closeRecoveryModal(); } 
            else { showAlert("‚ùå " + result.message); }
        } catch (e) { showAlert("üì° Connection error."); }
        btn.classList.remove('btn-loading'); btn.disabled = false;
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('staff-password');
        const eyeIcon = document.getElementById('eye-icon');
        passwordInput.type = (passwordInput.type === 'password') ? 'text' : 'password';
        eyeIcon.innerText = (passwordInput.type === 'password') ? 'üëÅÔ∏è' : 'üîí';
    }

    function getDeviceId() {
        let id = localStorage.getItem('unitech_device_id');
        if (!id) { id = 'dev-' + Math.random().toString(36).substr(2, 9) + Date.now(); localStorage.setItem('unitech_device_id', id); }
        return id;
    }

    function toggleAuthMode(mode) {
        authMode = mode;
        const indicator = document.getElementById('tab-indicator');
        const loginTab = document.getElementById('tab-login');
        const signupTab = document.getElementById('tab-signup');
        
        if (mode === 'signup') {
            indicator.style.left = '50%';
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            document.getElementById('display_name').style.display = 'block';
            document.getElementById('security-section').style.display = 'block';
            document.getElementById('forgot-password-area').style.visibility = 'hidden';
        } else {
            indicator.style.left = '0';
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            document.getElementById('display_name').style.display = 'none';
            document.getElementById('security-section').style.display = 'none';
            document.getElementById('forgot-password-area').style.visibility = 'visible';
        }
        updateClock();
    }

    window.onload = () => {
        const isApp = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isApp) {
            document.getElementById('install-overlay').style.display = 'none';
            const sessionActive = localStorage.getItem('unitech_session_active');
            const savedName = localStorage.getItem('unitech_display_name');
            const userId = localStorage.getItem('unitech_user_id');
            if (sessionActive === "true" && savedName) {
                const now = new Date(); const nigeria = new Date(now.toLocaleString("en-US", {timeZone: "Africa/Lagos"}));
                const isMeetingWindow = (nigeria.getDay() === 5) && (nigeria.getHours() > 8 || (nigeria.getHours() === 8 && nigeria.getMinutes() >= 55)) && (nigeria.getHours() < 14);
                if (isMeetingWindow || ALL_BYPASS.includes(userId)) {
                    if (userId === SUPER_ADMIN) document.getElementById('admin-note').style.display = 'block';
                    if (ALL_BYPASS.includes(userId)) document.getElementById('attendance-counter').style.display = 'block';
                    startMeeting(savedName);
                }
            }
        } else {
            document.getElementById('install-overlay').style.display = 'flex';
            if (/iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase())) {
                document.getElementById('ios-instructions').style.display = 'block';
                document.getElementById('install-btn-main').style.display = 'none';
            }
        }
        updateClock(); setInterval(updateClock, 1000); setInterval(fetchAttendance, 10000);
    };

    function updateClock() {
        if (inMeeting) return;
        const now = new Date(); const nigeria = new Date(now.toLocaleString("en-US", {timeZone: "Africa/Lagos"}));
        const day = nigeria.getDay(), hrs = nigeria.getHours(), mins = nigeria.getMinutes();
        const statusBox = document.getElementById('time-status'), loginBtn = document.getElementById('login-btn');
        const userIn = document.getElementById('username').value.trim().toLowerCase();
        const isMeetingWindow = (day === 5) && (hrs > 8 || (hrs === 8 && mins >= 55)) && (hrs < 14);

        statusBox.classList.remove('super-admin-status');
        loginBtn.classList.remove('super-admin-btn');

        if (userIn === SUPER_ADMIN) {
            statusBox.classList.add('super-admin-status');
            statusBox.innerHTML = "üëë SUPER ADMIN ACCESS GRANTED";
            loginBtn.classList.add('super-admin-btn');
            loginBtn.disabled = false; loginBtn.innerText = "Enter Portal";
        } else if (ADMIN_LIST.includes(userIn)) {
            statusBox.style.background = "#fff5f5"; statusBox.style.color = "var(--warning)";
            statusBox.innerHTML = "üõ°Ô∏è ADMIN ACCESS DETECTED";
            loginBtn.disabled = false; loginBtn.innerText = "Enter Portal";
        } else if (authMode === 'signup') {
            statusBox.style.background = "#eef6ff"; statusBox.innerHTML = "üìù REGISTRATION PORTAL OPEN";
            loginBtn.disabled = false; loginBtn.innerText = "Create My Account";
        } else {
            if (isMeetingWindow) { statusBox.style.background = "#f0fff4"; statusBox.innerHTML = "‚úÖ MEETING IS LIVE"; loginBtn.disabled = false; loginBtn.innerText = "Join Meeting"; }
            else { statusBox.style.background = "#fff5f5"; statusBox.innerHTML = "üîí PORTAL LOCKED (FRI 8:55AM)"; loginBtn.disabled = true; loginBtn.innerText = "Meeting Locked"; }
        }
    }

    async function handleAuth() {
        const userIn = document.getElementById('username').value.trim().toLowerCase();
        const passIn = document.getElementById('staff-password').value;
        const nameIn = document.getElementById('display_name').value.trim();
        const secAns = document.getElementById('security_answer')?.value.trim();
        const btn = document.getElementById('login-btn');

        if (authMode === 'signup' && (!userIn || !passIn || !nameIn || !secAns)) { showAlert("Fill all fields."); return; }
        btn.classList.add('btn-loading'); btn.disabled = true;

        try {
            const response = await fetch(authURL, { method: 'POST', body: JSON.stringify({ action: authMode === 'signup' ? "signup" : "login_check", username: userIn, password: passIn, displayName: nameIn, deviceId: getDeviceId(), securityAnswer: secAns })});
            const result = await response.json();
            if (result.status === "success") {
                if (authMode === 'signup') { showAlert("Account Created! You can now Login."); toggleAuthMode('login'); } 
                else {
                    localStorage.setItem('unitech_user_id', userIn);
                    localStorage.setItem('unitech_display_name', result.displayName);
                    localStorage.setItem('unitech_session_active', "true");
                    if (userIn === SUPER_ADMIN) document.getElementById('admin-note').style.display = 'block';
                    if (ALL_BYPASS.includes(userIn)) document.getElementById('attendance-counter').style.display = 'block';
                    startMeeting(result.displayName);
                }
            } else { showAlert(result.message); }
        } catch (e) { showAlert("Connection error."); }
        btn.classList.remove('btn-loading'); btn.disabled = false;
    }

    async function startMeeting(displayName) {
        if (api) api.dispose(); inMeeting = true;
        document.getElementById('setup-container').style.display = 'none';
        const h = document.getElementById('session-header'), f = document.getElementById('meeting-frame');
        h.style.display = 'block'; f.style.display = 'block';
        f.style.marginTop = h.offsetHeight + 'px'; f.style.height = `calc(100vh - ${h.offsetHeight}px)`;
        if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: displayName, action: "Joined" })});
        api = new JitsiMeetExternalAPI("8x8.vc", { roomName: ROOM_NAME, parentNode: f, userInfo: { displayName: displayName }, configOverwrite: { startWithAudioMuted: true, prejoinPageEnabled: false }});
        api.addEventListener('videoConferenceLeft', () => { inMeeting = false; localStorage.removeItem('unitech_session_active'); window.location.reload(); });
    }

    async function fetchAttendance() {
        const id = localStorage.getItem('unitech_user_id') || "";
        if(!ALL_BYPASS.includes(id.toLowerCase())) return;
        try {
            const res = await fetch(scriptURL + "?action=getCount");
            const data = await res.json();
            const counter = document.getElementById('attendance-counter');
            counter.style.display = 'block';
            counter.innerText = `üë• Live Attendance: ${data.count} Staff Online`;
        } catch (e) {}
    }

    async function resetUserDevice() {
        const target = prompt("Enter Username to Reset:");
        if (target) { await fetch(authURL, { method: 'POST', body: JSON.stringify({ action: "reset_device", username: target.toLowerCase() })}); showAlert("Reset successful."); }
    }

    async function clearAttendanceData() { if (confirm("Clear attendance?")) { await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "clear_attendance" })}); showAlert("Cleared."); } }
    function revealAdminButton() { if (prompt("Admin Password:") === "Salako2020") { document.getElementById('admin-download-btn').style.display = "block"; } }
    function logout() { localStorage.clear(); window.location.reload(); }
</script>
</body>
</html>
