<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Unitech Global Meeting | Secure Portal</title>
    
    <script src='https://8x8.vc/vpaas-magic-cookie-395f8038d65045c8b17c1bb294011a0c/external_api.js'></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --navy: #001f3f;
            --accent: #0078d4;
            --light-gray: #f4f7f9;
            --text-dark: #333;
            --success: #28a745;
            --warning: #d9534f;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray); color: var(--text-dark);
            overflow: hidden;
        }

        body {
            background: linear-gradient(135deg, #001f3f 0%, #003366 100%);
            display: flex; justify-content: center; align-items: center;
        }

        /* SECTION: UI Containers - RESTORED */
        #setup-container, #post-meeting-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            text-align: center; width: 90%; max-width: 400px;
            z-index: 10;
        }

        .logo { max-width: 150px; margin-bottom: 20px; }
        h1 { color: var(--navy); font-size: 24px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        p { color: #666; margin-bottom: 20px; font-size: 14px; }

        /* SECTION: Time Lock Styling - RESTORED */
        #time-status {
            font-size: 13px; font-weight: 600; padding: 12px;
            border-radius: 8px; margin-bottom: 20px;
            background: #fff5f5; color: var(--warning);
            border: 1px solid #feb2b2;
        }

        input {
            width: 100%; padding: 12px 15px; margin-bottom: 15px;
            border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none;
        }

        button {
            width: 100%; padding: 14px; background-color: var(--navy); color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: 0.3s;
        }

        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Bypass Highlight */
        .admin-mode { background-color: var(--accent) !important; box-shadow: 0 0 15px rgba(0,120,212,0.5); }

        /* SECTION: Header with Notch Fix - RESTORED */
        #session-header {
            display: none; background: white; width: 100%;
            padding: calc(12px + env(safe-area-inset-top)) 0 12px 0;
            text-align: center; border-bottom: 2px solid var(--accent);
            position: fixed; top: 0; z-index: 999;
        }

        #session-header h3 { margin: 0; color: var(--navy); font-size: 13px; text-transform: uppercase; }

        #meeting-frame { display: none; width: 100vw; background: black; }
        .footer-credit { position: absolute; bottom: 20px; color: rgba(255,255,255,0.4); font-size: 11px; }
        #admin-download-btn { display: none; margin-top: 20px; background-color: var(--success); }
    </style>
</head>
<body>

    <div id="session-header">
        <h3>Unitech Global Resources Ltd: Official Weekly Meeting</h3>
    </div>

    <div id="setup-container">
        <img src="logo.png" alt="Unitech Logo" class="logo" onerror="this.style.display='none'">
        <h1>Staff Portal</h1>
        
        <div id="time-status">Syncing with Nigeria Time...</div>

        <div id="admin-note" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; text-align: left; border: 1px solid #ffeeba;">
            ‚ö†Ô∏è <strong>Admin Checklist / Bypass Active:</strong><br>
            ‚Ä¢ Ensure AI Bot is synced via Calendar.<br>
            ‚Ä¢ You have 24/7 Access to this Room.
        </div>

        <div style="background: #f0fff4; color: #22543d; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; text-align: left; border: 1px solid #c6f6d5;">
            ü§ñ <strong>Welcome:</strong> Unitech Global Resources Management welcome you to another weekly meeting.
        </div>

        <input type="text" id="username" placeholder="Username" oninput="checkBypass()">
        <input type="password" id="staff-password" placeholder="Password">
        
        <button id="login-btn" onclick="handleLogin()" disabled>Locked</button>
    </div>

    <div id="meeting-frame"></div>

    <div id="post-meeting-container" style="display: none;">
        <img src="logo.png" alt="Unitech Logo" class="logo" style="max-width: 100px; cursor: help;" onclick="revealAdminButton()">
        <h2>Meeting Concluded</h2>
        <p>Attendance has been logged successfully.</p>
        <button id="admin-download-btn" onclick="window.open('https://otter.ai/my-notes')">üìÇ Open Otter.ai Minutes</button>
        <br><br>
        <button onclick="logout()" style="background: #666; width: auto; padding: 10px 20px;">Logout & Exit</button>
    </div>

    <div class="footer-credit">Powered by Zion Netcom Solutions Limited</div>

    <script>
        // --- API CONFIGURATION ---
        const authURL = "https://script.google.com/macros/s/AKfycbycFspIkYThsmblFNy4DNl0lJKrZO3gU6jx_fkyUQlpeAuNzlI8ykFgc-v0mKAwF9lC/exec"; 
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyjzjsY0hgQWwsohlDnvAEsbnhapTPZUaAGg6rPWJ0MV3GpMC8OKhlNBTpAH0PS4KDrSg/exec';
        const ROOM_NAME = "vpaas-magic-cookie-395f8038d65045c8b17c1bb294011a0c/Unitech-Global-Weekly-Meeting";
        
        // --- BYPASS USERS: NAMES THAT CAN ENTER ANYTIME ---
        const BYPASS_LIST = ["dayosalako", "temitopeadeyemi", "faizeljappie", "kabiroyekunle"];

        let api = null;
        let isGlobalMeetingTime = false;

        // --- TIME GATE LOGIC: FRIDAY 8:55 AM NIGERIA ---
        function updateClock() {
            const now = new Date();
            const nigeria = new Date(now.toLocaleString("en-US", {timeZone: "Africa/Lagos"}));
            
            const day = nigeria.getDay(); // 5 = Friday
            const hrs = nigeria.getHours();
            const mins = nigeria.getMinutes();
            
            const statusBox = document.getElementById('time-status');
            const loginBtn = document.getElementById('login-btn');

            const isFriday = (day === 5);
            const isTime = (hrs > 8 || (hrs === 8 && mins >= 55));

            if (isFriday && isTime) {
                isGlobalMeetingTime = true;
                if (!isBypassUser()) {
                    statusBox.style.background = "#f0fff4"; statusBox.style.color = "#28a745";
                    statusBox.innerHTML = "‚úÖ Meeting is OPEN (Starts 9:00 AM)";
                    loginBtn.disabled = false; loginBtn.innerText = "Login & Join Meeting";
                    loginBtn.classList.remove('admin-mode');
                }
            } else {
                isGlobalMeetingTime = false;
                if (!isBypassUser()) {
                    loginBtn.disabled = true;
                    statusBox.style.background = "#fff5f5"; statusBox.style.color = var(--warning);
                    statusBox.innerHTML = "üîí Closed. Unlocks Friday at 8:55 AM.";
                    loginBtn.innerText = "Meeting Locked";
                    loginBtn.classList.remove('admin-mode');
                }
            }
        }

        // --- BYPASS HELPER FUNCTIONS ---
        function isBypassUser() {
            const val = document.getElementById('username').value.trim().toLowerCase();
            return BYPASS_LIST.includes(val);
        }

        function checkBypass() {
            const note = document.getElementById('admin-note');
            const loginBtn = document.getElementById('login-btn');
            const statusBox = document.getElementById('time-status');

            if (isBypassUser()) {
                note.style.display = "block";
                loginBtn.disabled = false;
                loginBtn.innerText = "Admin Bypass Access";
                loginBtn.classList.add('admin-mode');
                statusBox.style.background = "#eef6ff"; statusBox.style.color = "#0078d4";
                statusBox.innerHTML = "üíé Bypass Account Recognized";
            } else {
                note.style.display = "none";
                updateClock();
            }
        }

        setInterval(updateClock, 1000);
        updateClock();

        // --- PERSISTENT LOGIN CHECK ---
        window.onload = () => {
            const savedName = localStorage.getItem('unitech_display_name');
            const isLoggedIn = localStorage.getItem('unitech_authenticated');
            if (isLoggedIn === "true" && savedName && (isGlobalMeetingTime || isBypassUser())) {
                startMeeting(true, savedName);
            }
        };

        // --- DATABASE LOGIN LOGIC ---
        async function handleLogin() {
            const userIn = document.getElementById('username').value.trim().toLowerCase();
            const passIn = document.getElementById('staff-password').value;
            const btn = document.getElementById('login-btn');

            btn.innerText = "Authenticating..."; btn.disabled = true;

            try {
                const response = await fetch(authURL, { method: 'POST', body: JSON.stringify({ username: userIn, password: passIn }) });
                const result = await response.json();

                if (result.status === "success") {
                    localStorage.setItem('unitech_user_id', userIn);
                    localStorage.setItem('unitech_display_name', result.displayName);
                    localStorage.setItem('unitech_authenticated', "true");
                    startMeeting(false, result.displayName);
                } else {
                    alert("Invalid Credentials. Please check with your supervisor.");
                    checkBypass();
                }
            } catch (e) {
                alert("Auth Connection Error. Check your internet.");
                checkBypass();
            }
        }

        async function startMeeting(isAuto, displayName) {
            document.getElementById('setup-container').style.display = 'none';
            const header = document.getElementById('session-header');
            const frame = document.getElementById('meeting-frame');
            header.style.display = 'block'; frame.style.display = 'block';

            const headerHeight = header.offsetHeight;
            frame.style.marginTop = headerHeight + 'px';
            frame.style.height = `calc(100vh - ${headerHeight}px)`;

            // RESTORED: Attendance Logger
            if (!isAuto) {
                fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: displayName, action: "Joined" }) });
            }

            // 8x8 JAAS INITIALIZATION
            api = new JitsiMeetExternalAPI("8x8.vc", {
                roomName: ROOM_NAME,
                width: "100%", height: "100%",
                parentNode: document.querySelector('#meeting-frame'),
                userInfo: { displayName: displayName },
                configOverwrite: { startWithAudioMuted: true, prejoinPageEnabled: false }
            });

            api.addEventListener('videoConferenceLeft', () => {
                header.style.display = 'none'; frame.style.display = 'none';
                document.getElementById('post-meeting-container').style.display = 'block';
                api.dispose();
            });
        }

        // RESTORED: Hidden Admin Control
        function revealAdminButton() {
            if (prompt("Admin Password:") === "Salako2020") {
                document.getElementById('admin-download-btn').style.display = "block";
            }
        }

        function logout() { localStorage.clear(); window.location.reload(); }
    </script>
</body>
</html>
